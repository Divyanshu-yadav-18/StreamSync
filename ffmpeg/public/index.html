<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFmpeg Stream Tester</title>
</head>
<body>
    <h1>FFmpeg Stream Tester</h1>
    <p>Select a video file to stream to the backend.</p>

    <input type="file" id="videoInput" />
    <button onclick="startStream()">Start Upload Stream</button>

    <h3>Status: <span id="status">Idle</span></h3>
    <div id="logs" style="background: #f0f0f0; padding: 10px; margin-top: 10px;"></div>

    <script>
        async function startStream() {
            const input = document.getElementById('videoInput');
            const status = document.getElementById('status');
            const logs = document.getElementById('logs');

            if (!input.files[0]) {
                alert("Please select a file first");
                return;
            }

            const file = input.files[0];
            const roomId = "test-room-1"; // Hardcoded for testing

            status.innerText = "Streaming...";
            logs.innerHTML += `<p>Starting stream for ${file.name}...</p>`;

            try {
                // 2. The Magic Fetch Call
                // This simulates exactly what the React Frontend will do
                const response = await fetch(`/stream?roomId=${roomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    // 'duplex' is required for streaming bodies in Chrome/Edge
                    duplex: 'half', 
                    body: file.stream() 
                });

                if (response.ok) {
                    status.innerText = "Stream Started!";
                    logs.innerHTML += `<p>Server responded: OK. Check your server logs/files.</p>`;
                } else {
                    status.innerText = "Error";
                    logs.innerHTML += `<p>Error: ${response.statusText}</p>`;
                }
            } catch (err) {
                console.error(err);
                status.innerText = "Failed";
                logs.innerHTML += `<p>Connection Failed: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>
